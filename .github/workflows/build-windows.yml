name: Build Windows Installer

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'liberica'
        
    - name: Build JAR with Maven
      working-directory: Downloader/MultiSiteDownloaderFX
      run: |
        mvn clean package -DskipTests
        mvn dependency:copy-dependencies -DoutputDirectory=target/libs
        
    - name: Prepare bundle
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "MultiDownloader/lib"
        New-Item -ItemType Directory -Force -Path "MultiDownloader/scripts"
        New-Item -ItemType Directory -Force -Path "MultiDownloader/StreamingCommunity"
        
        Copy-Item "Downloader/MultiSiteDownloaderFX/target/MultiSiteDownloaderFX-0.1.0-SNAPSHOT.jar" "MultiDownloader/lib/"
        Copy-Item "Downloader/MultiSiteDownloaderFX/target/libs/*.jar" "MultiDownloader/lib/"
        Get-ChildItem "MultiDownloader/lib/*-mac*.jar" | Remove-Item -ErrorAction SilentlyContinue
        Get-ChildItem "MultiDownloader/lib/*-linux*.jar" | Remove-Item -ErrorAction SilentlyContinue
        Copy-Item "tmp/*.py" "MultiDownloader/scripts/" -ErrorAction SilentlyContinue
        Copy-Item -Recurse "Downloader/StreamingCommunity/StreamingCommunity-main/*" "MultiDownloader/StreamingCommunity/"
        
        # Download config.json for StreamingCommunity
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/Arrowar/StreamingCommunity/refs/heads/main/config.json" -OutFile "MultiDownloader/config.json"
        Copy-Item "MultiDownloader/config.json" "MultiDownloader/StreamingCommunity/config.json"

    - name: Create silent install script
      shell: pwsh
      run: |
        @'
        # Silent installation script - runs hidden during Inno Setup
        $scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path

        # Set permissions
        icacls $scriptDir /grant Users:F /T 2>$null

        # Install Chocolatey if needed
        $chocoPath = Get-Command choco -ErrorAction SilentlyContinue
        if (-not $chocoPath) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
            $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
        }

        # Install dependencies via Chocolatey
        choco install liberica21jdkfull -y --force 2>$null
        choco install python311 -y --force 2>$null
        choco install ffmpeg -y --force 2>$null

        # Refresh PATH
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

        # Find Python
        $pythonPaths = @("C:\Python311\python.exe", "C:\Program Files\Python311\python.exe", "$env:LOCALAPPDATA\Programs\Python\Python311\python.exe")
        $pythonExe = "python"
        foreach ($p in $pythonPaths) { if (Test-Path $p) { $pythonExe = $p; break } }

        # Install Python packages
        & $pythonExe -m pip install --upgrade pip 2>$null
        & $pythonExe -m pip install httpx bs4 rich tqdm m3u8 psutil unidecode curl_cffi jsbeautifier pathvalidate pycryptodomex ua-generator qbittorrent-api pyTelegramBotAPI pywidevine python-dotenv requests lxml cssselect certifi fake-useragent 2>$null

        # Download config if needed
        $configPath = Join-Path $scriptDir "config.json"
        $scConfigPath = Join-Path $scriptDir "StreamingCommunity\config.json"
        if (-not (Test-Path $configPath)) {
            try { Invoke-WebRequest -Uri "https://raw.githubusercontent.com/Arrowar/StreamingCommunity/refs/heads/main/config.json" -OutFile $configPath } catch {}
        }
        if (-not (Test-Path $scConfigPath) -and (Test-Path $configPath)) { 
            Copy-Item $configPath $scConfigPath -Force 
        }
        '@ | Out-File -FilePath "MultiDownloader/INSTALLA-DIPENDENZE.ps1" -Encoding UTF8

    - name: Create launcher
      shell: pwsh
      run: |
        @'
        @echo off
        cd /d "%~dp0"
        setlocal enabledelayedexpansion

        REM Find Java
        set JAVA_EXE=java
        where java >nul 2>nul
        if %errorlevel% neq 0 (
            REM Try common paths
            if exist "C:\Program Files\BellSoft\LibericaJDK-21\bin\java.exe" (
                set JAVA_EXE=C:\Program Files\BellSoft\LibericaJDK-21\bin\java.exe
            ) else if exist "C:\Program Files\Java\jdk-21\bin\java.exe" (
                set JAVA_EXE=C:\Program Files\Java\jdk-21\bin\java.exe
            ) else if exist "C:\Program Files\Eclipse Adoptium\jdk-21*\bin\java.exe" (
                for /d %%d in ("C:\Program Files\Eclipse Adoptium\jdk-21*") do set JAVA_EXE=%%d\bin\java.exe
            ) else (
                echo.
                echo ========================================
                echo   ERRORE: Java non trovato!
                echo ========================================
                echo.
                echo Opzioni:
                echo 1. Riavvia il PC e riprova
                echo 2. Esegui INSTALLA-DIPENDENZE.bat come Admin
                echo.
                pause
                exit /b 1
            )
        )

        set PATH=%~dp0ffmpeg;%PATH%
        set PYTHONPATH=%~dp0StreamingCommunity

        REM Build classpath
        set CP=
        for %%f in ("%~dp0lib\*.jar") do set CP=!CP!%%f;

        REM Run with javaw (no console window)
        set JAVAW_EXE=!JAVA_EXE:java.exe=javaw.exe!
        "!JAVAW_EXE!" -cp "!CP!" com.topent3r.multi.MainApp
        '@ | Out-File -FilePath "MultiDownloader/MultiDownloader.bat" -Encoding ASCII
        
        # Create VBS launcher to hide console completely
        @'
        Set WshShell = CreateObject("WScript.Shell")
        WshShell.Run chr(34) & CreateObject("Scripting.FileSystemObject").GetParentFolderName(WScript.ScriptFullName) & "\MultiDownloader.bat" & chr(34), 0
        Set WshShell = Nothing
        '@ | Out-File -FilePath "MultiDownloader/MultiDownloader.vbs" -Encoding ASCII

    - name: Create README
      shell: pwsh  
      run: |
        @'
        ================================================
        MULTIDOWNLOADER v1.0
        Powered by @QuantixDev
        ================================================

        PRIMO AVVIO:
        1. Clicca destro su INSTALLA-DIPENDENZE.bat
        2. Seleziona "Esegui come amministratore"
        3. Attendi il completamento
        4. Riavvia il PC
        5. Doppio click su MultiDownloader.bat

        REQUISITI (installati automaticamente):
        - Java 21 (Liberica JDK Full)
        - Python 3.11
        - ffmpeg

        PROBLEMI?
        - Assicurati di eseguire come Amministratore
        - Riavvia il PC dopo l'installazione
        ================================================
        '@ | Out-File -FilePath "MultiDownloader/LEGGIMI.txt" -Encoding UTF8

    - name: Install Inno Setup
      run: choco install innosetup -y

    - name: Create Inno Setup script
      shell: pwsh
      run: |
        $iss = @"
        [Setup]
        AppId={{A1B2C3D4-E5F6-7890-ABCD-EF1234567890}
        AppName=MultiDownloader
        AppVersion=1.0
        AppPublisher=QuantixDev
        DefaultDirName={autopf}\MultiDownloader
        DefaultGroupName=MultiDownloader
        OutputDir=.
        OutputBaseFilename=MultiDownloader-Setup
        Compression=lzma2/ultra64
        SolidCompression=yes
        WizardStyle=modern
        PrivilegesRequired=admin

        [Languages]
        Name: "english"; MessagesFile: "compiler:Default.isl"

        [Tasks]
        Name: "desktopicon"; Description: "Crea icona sul Desktop"; Flags: unchecked

        [Files]
        Source: "MultiDownloader\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

        [Icons]
        Name: "{group}\MultiDownloader"; Filename: "{app}\MultiDownloader.vbs"
        Name: "{autodesktop}\MultiDownloader"; Filename: "{app}\MultiDownloader.vbs"; Tasks: desktopicon

        [Run]
        Filename: "powershell.exe"; Parameters: "-NoProfile -ExecutionPolicy Bypass -File ""{app}\INSTALLA-DIPENDENZE.ps1"""; StatusMsg: "Installazione dipendenze..."; Flags: runhidden waituntilterminated
        Filename: "{app}\MultiDownloader.vbs"; Description: "Avvia MultiDownloader"; Flags: postinstall nowait skipifsilent unchecked
        "@
        $iss | Out-File -FilePath "setup.iss" -Encoding ASCII

    - name: Build installer
      shell: cmd
      run: |
        "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss

    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: MultiDownloader-Setup
        path: MultiDownloader-Setup.exe
