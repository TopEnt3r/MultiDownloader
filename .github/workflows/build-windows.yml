name: Build Windows Installer

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'liberica'
        
    - name: Build JAR with Maven
      working-directory: Downloader/MultiSiteDownloaderFX
      run: |
        mvn clean package -DskipTests
        mvn dependency:copy-dependencies -DoutputDirectory=target/libs
        
    - name: Prepare bundle
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "MultiDownloader/lib"
        New-Item -ItemType Directory -Force -Path "MultiDownloader/scripts"
        New-Item -ItemType Directory -Force -Path "MultiDownloader/StreamingCommunity"
        
        Copy-Item "Downloader/MultiSiteDownloaderFX/target/MultiSiteDownloaderFX-0.1.0-SNAPSHOT.jar" "MultiDownloader/lib/"
        Copy-Item "Downloader/MultiSiteDownloaderFX/target/libs/*.jar" "MultiDownloader/lib/"
        Get-ChildItem "MultiDownloader/lib/*-mac*.jar" | Remove-Item -ErrorAction SilentlyContinue
        Get-ChildItem "MultiDownloader/lib/*-linux*.jar" | Remove-Item -ErrorAction SilentlyContinue
        Copy-Item "tmp/*.py" "MultiDownloader/scripts/" -ErrorAction SilentlyContinue
        Copy-Item -Recurse "Downloader/StreamingCommunity/StreamingCommunity-main/*" "MultiDownloader/StreamingCommunity/"
        
        # Download config.json for StreamingCommunity
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/Arrowar/StreamingCommunity/refs/heads/main/config.json" -OutFile "MultiDownloader/config.json"
        Copy-Item "MultiDownloader/config.json" "MultiDownloader/StreamingCommunity/config.json"

    - name: Create install script
      shell: pwsh
      run: |
        @'
        @echo off
        echo ========================================
        echo   MultiDownloader - Installazione
        echo   Powered by @QuantixDev
        echo ========================================
        echo.
        echo Installazione dipendenze in corso...
        echo.

        REM Disable Windows Store Python aliases
        echo Disabilitazione alias Python Microsoft Store...
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\App Paths\python.exe" /ve /d "" /f >nul 2>nul
        reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\App Paths\python3.exe" /ve /d "" /f >nul 2>nul

        REM Check if Chocolatey exists
        where choco >nul 2>nul
        if %errorlevel% neq 0 (
            echo Installazione Chocolatey...
            powershell -NoProfile -ExecutionPolicy Bypass -Command "Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))"
            call refreshenv
        )

        echo Installazione Java 21...
        choco install liberica21jdkfull -y --force
        call refreshenv

        echo Installazione Python 3.11...
        choco install python311 -y --force
        call refreshenv

        echo Installazione ffmpeg...
        choco install ffmpeg -y --force
        call refreshenv

        REM Add Python to current session PATH
        for /f "tokens=*" %%i in ('where python 2^>nul') do set PYTHON_PATH=%%~dpi
        if defined PYTHON_PATH set PATH=%PYTHON_PATH%;%PATH%

        REM Try multiple Python paths
        set PYTHON_EXE=python
        if exist "C:\Python311\python.exe" set PYTHON_EXE=C:\Python311\python.exe
        if exist "C:\Program Files\Python311\python.exe" set PYTHON_EXE=C:\Program Files\Python311\python.exe
        if exist "%LOCALAPPDATA%\Programs\Python\Python311\python.exe" set PYTHON_EXE=%LOCALAPPDATA%\Programs\Python\Python311\python.exe

        echo Installazione librerie Python...
        "%PYTHON_EXE%" -m pip install --upgrade pip
        "%PYTHON_EXE%" -m pip install requests beautifulsoup4 httpx tqdm rich m3u8 ua-generator pycryptodome fake-useragent unidecode certifi charset-normalizer idna urllib3 anyio sniffio h11 httpcore socksio

        REM Download config.json if not exists
        if not exist "%~dp0config.json" (
            echo Download config.json...
            curl -o "%~dp0config.json" https://raw.githubusercontent.com/Arrowar/StreamingCommunity/refs/heads/main/config.json 2>nul
            if not exist "%~dp0config.json" (
                powershell -Command "Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/Arrowar/StreamingCommunity/refs/heads/main/config.json' -OutFile '%~dp0config.json'"
            )
        )
        if not exist "%~dp0StreamingCommunity\config.json" copy "%~dp0config.json" "%~dp0StreamingCommunity\config.json"

        REM Set write permissions
        icacls "%~dp0" /grant Users:F /T >nul 2>nul

        echo.
        echo ========================================
        echo   Installazione completata!
        echo   RIAVVIA IL PC e poi avvia MultiDownloader
        echo ========================================
        pause
        '@ | Out-File -FilePath "MultiDownloader/INSTALLA-DIPENDENZE.bat" -Encoding ASCII

    - name: Create launcher
      shell: pwsh
      run: |
        @'
        @echo off
        cd /d "%~dp0"
        setlocal enabledelayedexpansion

        REM Find Java
        set JAVA_EXE=java
        where java >nul 2>nul
        if %errorlevel% neq 0 (
            REM Try common paths
            if exist "C:\Program Files\BellSoft\LibericaJDK-21\bin\java.exe" (
                set JAVA_EXE=C:\Program Files\BellSoft\LibericaJDK-21\bin\java.exe
            ) else if exist "C:\Program Files\Java\jdk-21\bin\java.exe" (
                set JAVA_EXE=C:\Program Files\Java\jdk-21\bin\java.exe
            ) else if exist "C:\Program Files\Eclipse Adoptium\jdk-21*\bin\java.exe" (
                for /d %%d in ("C:\Program Files\Eclipse Adoptium\jdk-21*") do set JAVA_EXE=%%d\bin\java.exe
            ) else (
                echo.
                echo ========================================
                echo   ERRORE: Java non trovato!
                echo ========================================
                echo.
                echo Opzioni:
                echo 1. Riavvia il PC e riprova
                echo 2. Esegui INSTALLA-DIPENDENZE.bat come Admin
                echo.
                pause
                exit /b 1
            )
        )

        set PATH=%~dp0ffmpeg;%PATH%
        set PYTHONPATH=%~dp0StreamingCommunity

        REM Build classpath
        set CP=
        for %%f in ("%~dp0lib\*.jar") do set CP=!CP!%%f;

        REM Run with javaw (no console window)
        set JAVAW_EXE=!JAVA_EXE:java.exe=javaw.exe!
        "!JAVAW_EXE!" -cp "!CP!" com.topent3r.multi.MainApp
        '@ | Out-File -FilePath "MultiDownloader/MultiDownloader.bat" -Encoding ASCII
        
        # Create VBS launcher to hide console completely
        @'
        Set WshShell = CreateObject("WScript.Shell")
        WshShell.Run chr(34) & CreateObject("Scripting.FileSystemObject").GetParentFolderName(WScript.ScriptFullName) & "\MultiDownloader.bat" & chr(34), 0
        Set WshShell = Nothing
        '@ | Out-File -FilePath "MultiDownloader/MultiDownloader.vbs" -Encoding ASCII

    - name: Create README
      shell: pwsh  
      run: |
        @'
        ================================================
        MULTIDOWNLOADER v1.0
        Powered by @QuantixDev
        ================================================

        PRIMO AVVIO:
        1. Clicca destro su INSTALLA-DIPENDENZE.bat
        2. Seleziona "Esegui come amministratore"
        3. Attendi il completamento
        4. Riavvia il PC
        5. Doppio click su MultiDownloader.bat

        REQUISITI (installati automaticamente):
        - Java 21 (Liberica JDK Full)
        - Python 3.11
        - ffmpeg

        PROBLEMI?
        - Assicurati di eseguire come Amministratore
        - Riavvia il PC dopo l'installazione
        ================================================
        '@ | Out-File -FilePath "MultiDownloader/LEGGIMI.txt" -Encoding UTF8

    - name: Install Inno Setup
      run: choco install innosetup -y

    - name: Create Inno Setup script
      shell: pwsh
      run: |
        @'
        [Setup]
        AppId={{A1B2C3D4-E5F6-7890-ABCD-EF1234567890}
        AppName=MultiDownloader
        AppVersion=1.0
        AppPublisher=QuantixDev
        DefaultDirName={autopf}\MultiDownloader
        DefaultGroupName=MultiDownloader
        OutputDir=.
        OutputBaseFilename=MultiDownloader-Setup
        Compression=lzma2/ultra64
        SolidCompression=yes
        WizardStyle=modern
        PrivilegesRequired=admin
        
        [Languages]
        Name: "english"; MessagesFile: "compiler:Default.isl"
        
        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; Flags: unchecked
        
        [Files]
        Source: "MultiDownloader\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
        
        [Icons]
        Name: "{group}\MultiDownloader"; Filename: "{app}\MultiDownloader.vbs"; IconFilename: "{sys}\shell32.dll"; IconIndex: 13
        Name: "{group}\Installa Dipendenze"; Filename: "{app}\INSTALLA-DIPENDENZE.bat"
        Name: "{autodesktop}\MultiDownloader"; Filename: "{app}\MultiDownloader.vbs"; IconFilename: "{sys}\shell32.dll"; IconIndex: 13; Tasks: desktopicon
        
        [Run]
        Filename: "{app}\INSTALLA-DIPENDENZE.bat"; Description: "Installa dipendenze (Java, Python, ffmpeg)"; Flags: postinstall runascurrentuser waituntilterminated
        '@ | Out-File -FilePath "setup.iss" -Encoding ASCII

    - name: Build installer
      shell: cmd
      run: |
        "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss

    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: MultiDownloader-Setup
        path: MultiDownloader-Setup.exe
